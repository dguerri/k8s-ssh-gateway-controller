digraph SimplifiedArchitecture {
    // Graph settings
    rankdir=TB;
    compound=true;
    splines=polyline;
    nodesep=1.0;
    ranksep=1.0;

    // Style definitions
    node [shape=box, style="rounded,filled", fontname="Arial", fontsize=12];
    edge [fontname="Arial", fontsize=10, penwidth=2];

    // ========================================
    // MAIN COMPONENTS
    // ========================================

    subgraph cluster_controllers {
        label="Controllers";
        style=filled;
        color="#E8F5E9";

        GatewayController [label="Gateway Controller\n\n• Manage SSH connection\n• Provide SetRoute/RemoveRoute\n• Update Gateway status", fillcolor="#A5D6A7", width=3];
        HTTPController [label="HTTPRoute Controller\n\n• Watch HTTPRoute\n• Call SetRoute/RemoveRoute", fillcolor="#90CAF9", width=3];
        TCPController [label="TCPRoute Controller\n\n• Watch TCPRoute\n• Call SetRoute/RemoveRoute", fillcolor="#90CAF9", width=3];
    }

    subgraph cluster_ssh {
        label="SSH Layer";
        style=filled;
        color="#FFE0B2";

        SSHManager [label="SSH Tunnel Manager\n\n• Connect/Disconnect\n• Start/Stop Forwardings\n• Monitor keepalive\n• Proxy traffic", fillcolor="#FFCC80", width=3];
    }

    subgraph cluster_external {
        label="External Systems";
        style=filled;
        color="#F3E5F5";

        K8sAPI [label="Kubernetes API", fillcolor="#E1BEE7", shape=ellipse];
        SSHServer [label="SSH Server\n(pico.sh/tuns.sh)", fillcolor="#E1BEE7"];
        Backend [label="Backend Services", fillcolor="#E1BEE7"];
    }

    // ========================================
    // MAIN FLOWS
    // ========================================

    // Kubernetes events
    K8sAPI -> GatewayController [label="  Gateway\n  events  ", color="#2196F3", style=dashed];
    K8sAPI -> HTTPController [label="  HTTPRoute\n  events  ", color="#2196F3", style=dashed];
    K8sAPI -> TCPController [label="  TCPRoute\n  events  ", color="#2196F3", style=dashed];

    // Route controllers to Gateway controller
    HTTPController -> GatewayController [label="  SetRoute()\n  RemoveRoute()  ", color="#4CAF50"];
    TCPController -> GatewayController [label="  SetRoute()\n  RemoveRoute()  ", color="#4CAF50"];

    // Gateway controller to SSH Manager
    GatewayController -> SSHManager [label="  Connect()\n  IsConnected()\n  StartForwarding()\n  StopForwarding()\n  GetAssignedAddresses()  ", color="#FF9800"];

    // Gateway controller to K8s API
    GatewayController -> K8sAPI [label="  Update\n  Gateway.status  ", color="#2196F3", style=dotted];

    // SSH Manager to external
    SSHManager -> SSHServer [label="  SSH Protocol\n  (forwardings)  ", color="#F44336", dir=both];
    SSHManager -> Backend [label="  Proxy\n  traffic  ", color="#4CAF50"];

    // ========================================
    // KEY FLOWS AS SUBGRAPHS
    // ========================================

    subgraph cluster_flow1 {
        label="Flow 1: Route Creation";
        style="rounded,filled";
        color="#E3F2FD";
        penwidth=2;

        flow1_1 [label="1. HTTPRoute created", fillcolor="#BBDEFB", shape=note];
        flow1_2 [label="2. HTTP Controller\ncalls SetRoute()", fillcolor="#90CAF9", shape=note];
        flow1_3 [label="3. Gateway Controller\ncalls StartForwarding()", fillcolor="#A5D6A7", shape=note];
        flow1_4 [label="4. SSH Manager\ncreates tunnel", fillcolor="#FFCC80", shape=note];
        flow1_5 [label="5. Gateway status\nupdated", fillcolor="#E1BEE7", shape=note];

        flow1_1 -> flow1_2 -> flow1_3 -> flow1_4 -> flow1_5 [style=invis];
    }

    subgraph cluster_flow2 {
        label="Flow 2: SSH Reconnection";
        style="rounded,filled";
        color="#FFF3E0";
        penwidth=2;

        flow2_1 [label="1. SSH disconnect\ndetected", fillcolor="#FFE0B2", shape=note];
        flow2_2 [label="2. Gateway Reconcile()\ncalls Connect()", fillcolor="#A5D6A7", shape=note];
        flow2_3 [label="3. SSH reconnects", fillcolor="#FFCC80", shape=note];
        flow2_4 [label="4. Routes reconcile\nvalidate forwardings", fillcolor="#90CAF9", shape=note];
        flow2_5 [label="5. Invalid forwardings\nre-established", fillcolor="#FFCC80", shape=note];

        flow2_1 -> flow2_2 -> flow2_3 -> flow2_4 -> flow2_5 [style=invis];
    }

    subgraph cluster_flow3 {
        label="Flow 3: Route Deletion";
        style="rounded,filled";
        color="#FFEBEE";
        penwidth=2;

        flow3_1 [label="1. HTTPRoute deleted", fillcolor="#FFCDD2", shape=note];
        flow3_2 [label="2. HTTP Controller\ncalls RemoveRoute()", fillcolor="#90CAF9", shape=note];
        flow3_3 [label="3. Gateway Controller\ncalls StopForwarding()", fillcolor="#A5D6A7", shape=note];
        flow3_4 [label="4. SSH Manager\ncleans tunnel", fillcolor="#FFCC80", shape=note];
        flow3_5 [label="5. Gateway status\nupdated", fillcolor="#E1BEE7", shape=note];

        flow3_1 -> flow3_2 -> flow3_3 -> flow3_4 -> flow3_5 [style=invis];
    }

}
